---
import { getCollection, render } from "astro:content";
import { Gamepad2, Heart, Sparkles, User } from "lucide-react";
import PlayerProfileCard from "@/components/ui/8bit/blocks/player-profile-card";
import {
	Card,
	CardContent,
	CardHeader,
	CardTitle,
} from "@/components/ui/8bit/card";
import { CornerDecorations } from "@/components/ui/8bit/corner-decorations";
import { InventoryList } from "@/components/ui/8bit/inventory-list";
import { PixelFooter } from "@/components/ui/8bit/pixel-footer";
import PixelNav from "@/components/ui/8bit/pixel-nav";
import { PixelScrollArea } from "@/components/ui/8bit/pixel-scroll-area";
import { Progress } from "@/components/ui/8bit/progress";
import { Separator } from "@/components/ui/8bit/separator";
import { ThemeToggle } from "@/components/ui/8bit/theme-toggle";
import Layout from "@/layouts/main.astro";

export async function getStaticPaths() {
	const profiles = await getCollection("profiles");
	return profiles.map((profile) => ({
		params: { slug: profile.id },
		props: { profile },
	}));
}

const { profile } = Astro.props;
const { Content } = await render(profile);
const {
	name,
	lore,
	image,
	subtitle,
	class: characterClass,
	origin,
	inventory,
	stats,
} = profile.data;
const imageSrc = `/images/profiles/${image}`;

// Map Chattini stats to PlayerProfileCard customStats format
const customStats = [
	{
		label: "Cuteness",
		value: stats.cuteness || 0,
		max: 100,
		color: "bg-accent",
		variant: "retro" as const,
	},
	{
		label: "Mischief",
		value: stats.mischief || 0,
		max: 100,
		color: "bg-blue-500",
		variant: "retro" as const,
	},
	{
		label: "Magic",
		value: stats.magic || 0,
		max: 100,
		color: "bg-indigo-500",
		variant: "retro" as const,
	},
];

const content = {
	title: `${name} - Chattinisona`,
};
---

<Layout {content}>
	<PixelNav current="profiles" client:load/>

	<main
		class="min-h-screen bg-dots relative pt-20 pb-8 px-4"
		transition:animate="slide"
	>
		<div class="max-w-5xl mx-auto relative">
			{/* Main container with corner decorations */}
			<div
				class="bg-white dark:bg-slate-900 border-4 border-foreground shadow-[4px_4px_0px_0px_hsl(var(--foreground))] dark:shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] relative overflow-hidden"
			>
				<CornerDecorations/>

				{/* Header Section */}
				<header
					class="flex flex-col md:flex-row justify-between items-start p-8 md:p-10 gap-8 relative z-10 bg-gradient-to-b from-blue-50 to-transparent dark:from-slate-800 dark:to-transparent"
				>
					{/* Left: Identity and subtitle */}
					<div class="flex-1 space-y-4 pt-4">
						<div class="flex items-end gap-3 flex-wrap">
							<span
								class="text-primary retro text-lg md:text-xl uppercase tracking-widest drop-shadow-sm"
							>
								Identity:
							</span>
							<h1
								class="text-4xl md:text-6xl retro text-slate-900 dark:text-white pixel-underline pb-4 w-full md:w-auto flex-grow tracking-tight"
							>
								{name}
							</h1>
						</div>

						{subtitle && (
							<div class="flex items-center gap-3 text-xl md:text-3xl text-blue-800 dark:text-blue-200">
								<Gamepad2 className="text-accent animate-pulse h-8 w-8" />
								<p class="font-bold">{subtitle}</p>
							</div>
						)}
					</div>

					{/* Right: Portrait with tilt effect */}
					<div class="relative group mx-auto md:mx-0">
						{/* Tilted accent background */}
						<div
							class="absolute -inset-2 bg-accent dark:bg-pink-700 border-4 border-foreground transform rotate-2 transition-transform group-hover:rotate-0 shadow-[2px_2px_0px_0px_hsl(var(--foreground))]"
						/>

						{/* Main portrait frame */}
						<div
							class="relative w-48 h-48 md:w-60 md:h-60 bg-blue-100 dark:bg-slate-800 border-4 border-foreground p-2 z-10"
						>
							<div
								class="w-full h-full bg-white dark:bg-slate-900 border-2 border-dashed border-blue-300 flex items-center justify-center overflow-hidden"
							>
								<img
									src={imageSrc}
									alt={name}
									class="w-full h-full object-contain pixel-art grayscale group-hover:grayscale-0 transition-all duration-300"
									loading="eager"
									transition:name={`profile-img-${profile.id}`}
								>
							</div>

							{/* Decorative icons */}
							<Sparkles
								className="absolute -top-5 -left-5 h-10 w-10 text-primary animate-bounce"
							/>
							<Heart
								className="absolute -bottom-4 -right-4 h-8 w-8 text-accent animate-bounce"
								style={{ animationDelay: "75ms" }}
							/>
						</div>
					</div>
				</header>

				{/* Content Grid */}
				<div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-6 md:p-10 pt-2">
					{/* Lore Data Section (2 columns) */}
					<section class="md:col-span-2 flex flex-col gap-4">
						<div class="flex items-center gap-3 mb-1">
							<div class="h-4 w-4 bg-primary border-2 border-foreground"></div>
							<h2 class="text-3xl retro text-primary">Lore Data</h2>
							<div class="h-1 flex-grow bg-blue-200 dark:bg-blue-900 relative">
								<div
									class="absolute top-0 left-0 h-full w-1/3 bg-primary animate-pulse"
								></div>
							</div>
						</div>

						<div
							class="bg-secondary dark:bg-slate-800 border-4 border-foreground p-1 shadow-[4px_4px_0px_0px_hsl(var(--foreground))] h-full min-h-[400px] relative group"
						>
							<div
								class="bg-white dark:bg-slate-900 border-2 border-primary h-full p-6 relative overflow-hidden"
							>
								{/* Grid background overlay */}
								<div
									class="absolute inset-0 opacity-10 pointer-events-none grid-overlay"
								></div>

								{/* Scrollable content */}
								<PixelScrollArea
									className="h-[360px] text-xl md:text-2xl leading-loose text-slate-700 dark:text-blue-100 space-y-6 relative z-10 font-medium lore-text"
								>
									<p>"{lore}"</p>
									<div class="prose prose-sm dark:prose-invert max-w-none">
										<Content/>
									</div>
								</PixelScrollArea>
							</div>
						</div>
					</section>

					{/* Stats Panel (1 column) */}
					<aside class="md:col-span-1 flex flex-col gap-6">
						<PlayerProfileCard
							client:load
							playerName={name}
							avatarSrc={imageSrc}
							level={stats.level}
							playerClass={stats.type || characterClass}
							showLevel={true}
							showHealth={false}
							showMana={false}
							showExperience={false}
							customStats={customStats}
						/>

						{/* Inventory */}
						{inventory && inventory.length > 0 && (
						<div
							class="bg-primary border-4 border-foreground p-1 shadow-[4px_4px_0px_0px_hsl(var(--accent))]"
						>
							<div
								class="bg-background-light dark:bg-slate-800 border-2 border-dashed border-white p-5"
							>
								<h3
									class="retro text-xs text-primary mb-3 uppercase text-center bg-blue-100 dark:bg-slate-700 py-1"
								>
									Inventory
								</h3>
								<InventoryList items={inventory} client:load/>
							</div>
						</div>
						)}
					</aside>
				</div>

				{/* Footer */}
				<PixelFooter/>
			</div>
		</div>

		{/* Theme Toggle */}
		<ThemeToggle client:only="react"/>
	</main>
</Layout>

<style>
	.prose :global(h1),
	.prose :global(h2),
	.prose :global(h3) {
		font-family: "Press Start 2P", cursive;
		line-height: 1.8;
		color: hsl(var(--primary));
		margin-top: 2rem;
	}

	.prose :global(h1) {
		font-size: 1.5rem;
	}
	.prose :global(h2) {
		font-size: 1.25rem;
	}
	.prose :global(h3) {
		font-size: 1rem;
	}

	.prose :global(p) {
		line-height: 1.8;
		margin-bottom: 1.5rem;
	}

	.prose :global(ul),
	.prose :global(ol) {
		padding-left: 1.5rem;
		margin-bottom: 1.5rem;
	}

	.prose :global(li) {
		margin-bottom: 0.5rem;
		line-height: 1.6;
	}

	.prose :global(strong) {
		color: hsl(var(--accent));
		font-weight: 600;
	}
</style>
